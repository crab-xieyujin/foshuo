import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// é…ç½®è·¯å¾„
const SCRIPTURES_DIR = path.join(__dirname, '../scriptures');
const OUTPUT_FILE = path.join(__dirname, '../src/data/scriptures.ts');

// ç¡®ä¿ç›®å½•å­˜åœ¨
if (!fs.existsSync(SCRIPTURES_DIR)) {
    console.error(`âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç»æ–‡ç›®å½•: ${SCRIPTURES_DIR}`);
    process.exit(1);
}

// è¯»å–æ‰€æœ‰ .txt æ–‡ä»¶
const files = fs.readdirSync(SCRIPTURES_DIR).filter(file => file.endsWith('.txt'));

if (files.length === 0) {
    console.warn(`âš ï¸ è­¦å‘Šï¼šscriptures ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ° .txt æ–‡ä»¶ã€‚`);
    // ä¸é€€å‡ºï¼Œå…è®¸ç”Ÿæˆç©ºåˆ—è¡¨ï¼ˆæˆ–ä¿ç•™é»˜è®¤ï¼‰
}

console.log(`ğŸ“š å‘ç° ${files.length} ä¸ªç»æ–‡æ–‡ä»¶ï¼Œå¼€å§‹å¤„ç†...`);

const scriptures = files.map(file => {
    const filePath = path.join(SCRIPTURES_DIR, file);
    const rawContent = fs.readFileSync(filePath, 'utf-8');

    // è§£ææ–‡ä»¶å†…å®¹
    // çº¦å®šï¼š
    // ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜
    // ç¬¬äºŒè¡Œï¼šä½œè€…/è¯‘è€…ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æƒ³å†™ä½œè€…ï¼Œç•™ç©ºè¡Œï¼‰
    // ç¬¬ä¸‰è¡ŒåŠä»¥åï¼šæ­£æ–‡

    const lines = rawContent.split(/\r?\n/);
    const title = lines[0] ? lines[0].trim() : 'æ— æ ‡é¢˜';
    const author = lines[1] ? lines[1].trim() : '';

    // ä»ç¬¬ä¸‰è¡Œå¼€å§‹æ˜¯æ­£æ–‡ï¼Œé‡æ–°ç»„åˆå¹¶å»é™¤é¦–å°¾ç©ºç™½
    const content = lines.slice(2).join('\n').trim();

    // ID ä½¿ç”¨æ–‡ä»¶åï¼ˆå»æ‰.txtï¼‰
    const id = path.basename(file, '.txt');

    // è®¡ç®—å­—æ•°
    const size = content.replace(/\s/g, '').length + 'å­—';

    return {
        id,
        title,
        author,
        description: content.substring(0, 60).replace(/\n/g, ' ') + '...', // è‡ªåŠ¨ç”Ÿæˆç®€ä»‹
        size,
        audioUrl: '/assets/audio/heart-sutra.mp3', // é»˜è®¤éŸ³é¢‘ï¼Œåç»­å¯æ‰©å±•
        content
    };
});

// ç”Ÿæˆ TypeScript ä»£ç 
const tsContent = `// âš ï¸ æ­¤æ–‡ä»¶ç”± scripts/import_scriptures.js è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
// âš ï¸ Generated by scripts/import_scriptures.js - DO NOT EDIT MANUALLY

export interface Scripture {
    id: string;
    title: string;
    author?: string;
    description: string;
    size?: string;
    coverImage?: string;
    audioUrl: string;
    bgmUrl?: string;
    content: string;
    pages?: string[];
}

export const scriptures: Scripture[] = ${JSON.stringify(scriptures, null, 4)};
`;

// å†™å…¥æ–‡ä»¶
fs.writeFileSync(OUTPUT_FILE, tsContent, 'utf-8');

console.log(`âœ… æˆåŠŸç”Ÿæˆ ${scriptures.length} éƒ¨ç»æ–‡åˆ° src/data/scriptures.ts`);
